# ğŸ¦ ShrimpBot - BGR Export WhatsApp Bot v2.0

Bot empresarial de WhatsApp para consultas de precios de camarÃ³n de BGR Export con arquitectura mejorada, seguridad robusta y mejores prÃ¡cticas de desarrollo.

## âœ¨ CaracterÃ­sticas Principales

### ğŸš€ Funcionalidades de Negocio
- ğŸ¤– **Interfaz conversacional inteligente** con IA opcional (OpenAI)
- ğŸ“Š **Datos en tiempo real** desde Google Sheets con fallback a Excel local
- ğŸ§® **CÃ¡lculos automÃ¡ticos precisos** usando fÃ³rmulas empresariales
- ğŸ¦ **CatÃ¡logo completo de productos**: HOSO, HLSO, P&D IQF, P&D BLOQUE, etc.
- ğŸ“ **Todas las tallas disponibles** con inventario en tiempo real
- ğŸ’° **Cotizaciones detalladas** con cÃ¡lculos FOB, Glaseo y Flete
- ğŸŒ **Soporte multi-destino** con costos de flete personalizados
- ğŸ“„ **GeneraciÃ³n de PDFs profesionales** en mÃºltiples idiomas (ES/EN)
- ğŸ¤ **TranscripciÃ³n de mensajes de audio** vÃ­a OpenAI

### ğŸ”’ Mejoras de Seguridad v2.0
- ğŸ›¡ï¸ **ValidaciÃ³n de webhooks Twilio** con firma criptogrÃ¡fica
- ğŸš¦ **Rate limiting inteligente** por usuario (30 req/min)
- ğŸ” **AutenticaciÃ³n Bearer** para endpoints administrativos
- ğŸ§¹ **SanitizaciÃ³n de entrada** contra inyecciones
- ğŸ“ **Logging estructurado** con filtrado de datos sensibles
- ğŸ” **Headers de seguridad** (HSTS, CSP, X-Frame-Options)
- âš¡ **ProtecciÃ³n contra spam** y mensajes duplicados
- ğŸ”‘ **GestiÃ³n segura de secretos** con validaciÃ³n en producciÃ³n

### ğŸ—ï¸ Arquitectura Mejorada
- ğŸ“¦ **InyecciÃ³n de dependencias** con ServiceContainer
- ğŸ¯ **Manejo robusto de errores** con excepciones personalizadas
- ğŸ“Š **Logging estructurado JSON** para anÃ¡lisis
- ğŸ”„ **Middleware de request tracking** con IDs Ãºnicos
- ğŸ“ˆ **MÃ©tricas y health checks** integrados
- ğŸ§ª **Arquitectura testeable** con separaciÃ³n de responsabilidades

## ğŸš€ InstalaciÃ³n y ConfiguraciÃ³n

### Prerrequisitos
- Python 3.11+
- Cuenta de Twilio con WhatsApp Business API
- Google Cloud Service Account (para Google Sheets)
- PostgreSQL/Redis (opcional para sesiones persistentes)

### InstalaciÃ³n Local

1. **Clona el repositorio**
   ```bash
   git clone https://github.com/tu-usuario/BGR-SHRIMP.git
   cd BGR-SHRIMP
   ```

2. **Crea entorno virtual**
   ```bash
   python -m venv venv
   venv\Scripts\activate  # Windows
   source venv/bin/activate  # Linux/Mac
   ```

3. **Instala dependencias**
   ```bash
   pip install -r requirements.txt
   ```

4. **Configura variables de entorno**
   ```bash
   cp .env.example .env
   # Edita .env con tus credenciales
   ```

5. **Ejecuta el bot**
   ```bash
   python start.py
   ```

## ğŸ”§ ConfiguraciÃ³n de Entorno

### Variables CrÃ­ticas (Requeridas)
```bash
# Twilio WhatsApp
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

# Seguridad
SECRET_KEY=<genera-con-secrets.token_urlsafe(32)>
ADMIN_API_TOKEN=<token-seguro-para-admin>
ENVIRONMENT=production  # development/staging/production
```

### Variables de Datos (Recomendadas)
```bash
# Google Sheets (tiempo real)
GOOGLE_SHEETS_ID=1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GOOGLE_SHEETS_CREDENTIALS='{"type":"service_account",...}'

# ConfiguraciÃ³n del servidor
BASE_URL=https://tu-dominio.com
PORT=8000
DEBUG=false
```

### Variables de Seguridad Adicionales
```bash
# Rate Limiting
RATE_LIMIT_MAX_REQUESTS=30
RATE_LIMIT_WINDOW_SECONDS=60

# Hosts y CORS
ALLOWED_HOSTS=tu-dominio.com,www.tu-dominio.com
CORS_ORIGINS=https://tu-frontend.com

# LÃ­mites
MAX_MESSAGE_LENGTH=1000
MAX_FILE_SIZE=10485760  # 10MB
REQUEST_TIMEOUT=30
```

## ğŸ“Š Arquitectura del Sistema

```
BGR-SHRIMP/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # AplicaciÃ³n FastAPI con middlewares
â”‚   â”œâ”€â”€ config.py            # ConfiguraciÃ³n centralizada
â”‚   â”œâ”€â”€ routes.py            # Endpoints con seguridad
â”‚   â”œâ”€â”€ dependencies.py      # Contenedor de servicios (DI)
â”‚   â”œâ”€â”€ security.py          # Utilidades de seguridad
â”‚   â”œâ”€â”€ exceptions.py        # Manejo de errores personalizado
â”‚   â”œâ”€â”€ logging_config.py    # Sistema de logging estructurado
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ pricing.py       # LÃ³gica de negocio principal
â”‚       â”œâ”€â”€ google_sheets.py # IntegraciÃ³n Google Sheets
â”‚       â”œâ”€â”€ excel.py         # Procesamiento Excel local
â”‚       â”œâ”€â”€ interactive.py   # MenÃºs interactivos
â”‚       â”œâ”€â”€ session.py       # GestiÃ³n de sesiones
â”‚       â”œâ”€â”€ pdf_generator.py # GeneraciÃ³n de cotizaciones
â”‚       â”œâ”€â”€ whatsapp_sender.py # Cliente Twilio
â”‚       â”œâ”€â”€ openai_service.py  # IA conversacional
â”‚       â””â”€â”€ audio_handler.py   # Procesamiento de audio
â”œâ”€â”€ data/                    # Archivos de datos
â”œâ”€â”€ logs/                    # Logs estructurados
â”œâ”€â”€ generated_pdfs/          # PDFs generados
â””â”€â”€ tests/                   # Suite de pruebas
```

## ğŸ”’ CaracterÃ­sticas de Seguridad

### AutenticaciÃ³n y AutorizaciÃ³n
- **Webhook Validation**: ValidaciÃ³n criptogrÃ¡fica de requests de Twilio
- **Bearer Auth**: Tokens para endpoints administrativos
- **Session Management**: Sesiones seguras por usuario

### ProtecciÃ³n contra Ataques
- **Rate Limiting**: LÃ­mite configurable por IP/usuario
- **Input Validation**: SanitizaciÃ³n estricta de entrada
- **CORS Policy**: Control de orÃ­genes permitidos
- **Security Headers**: ProtecciÃ³n XSS, Clickjacking, etc.

### Privacidad y Compliance
- **Data Sanitization**: Filtrado automÃ¡tico de datos sensibles en logs
- **Secure File Handling**: Manejo seguro de archivos temporales
- **Audit Logging**: Registro de eventos de seguridad

## ğŸ“± Uso del Bot

### Comandos Principales
- `menu` - MenÃº principal interactivo
- `precios` - Consulta directa de precios
- `confirmar` - Generar PDF de cotizaciÃ³n
- `idioma` - Cambiar idioma de proformas
- `ayuda` - Mostrar comandos disponibles

### Flujo de CotizaciÃ³n
1. **Consulta** â†’ "Precio HLSO 16/20"
2. **Respuesta** â†’ CotizaciÃ³n detallada con cÃ¡lculos
3. **ConfirmaciÃ³n** â†’ "confirmar"
4. **Idioma** â†’ SelecciÃ³n ES/EN
5. **PDF** â†’ EnvÃ­o automÃ¡tico por WhatsApp

### Consultas Inteligentes
```
"Necesito precio de HLSO 16/20 para China"
"CotizaciÃ³n P&D IQF 21/25 con 10% glaseo"
"15000 libras de EZ PEEL 26/30 destino Houston"
"Generar proforma para Juan PÃ©rez"
```

## ğŸ”§ Endpoints Administrativos

### GestiÃ³n del Sistema
```bash
# Health Check
GET /health
Authorization: Bearer <token>

# Recargar datos
POST /webhook/reload-data
Authorization: Bearer <admin-token>

# Estado de datos
GET /webhook/data-status
Authorization: Bearer <admin-token>

# Test de Twilio
GET /webhook/test-twilio
Authorization: Bearer <admin-token>
```

## ğŸ“ˆ Monitoreo y Logs

### Sistema de Logging
- **Structured Logging**: Formato JSON para anÃ¡lisis
- **Log Rotation**: RotaciÃ³n diaria automÃ¡tica
- **Error Tracking**: Logs separados para errores
- **Security Audit**: Log especÃ­fico de eventos de seguridad
- **Business Events**: MÃ©tricas de negocio (cotizaciones, PDFs)

### Archivos de Log
```
logs/
â”œâ”€â”€ app.log          # Log general de aplicaciÃ³n
â”œâ”€â”€ errors.log       # Errores y excepciones
â”œâ”€â”€ security.log     # Eventos de seguridad
â””â”€â”€ business.log     # MÃ©tricas de negocio
```

## ğŸš€ Despliegue en ProducciÃ³n

### Checklist de Seguridad
- [ ] `DEBUG=false` y `ENVIRONMENT=production`
- [ ] `SECRET_KEY` Ãºnica y segura
- [ ] `ADMIN_API_TOKEN` configurado
- [ ] `ALLOWED_HOSTS` restringido
- [ ] HTTPS habilitado con certificado vÃ¡lido
- [ ] Backup de datos configurado
- [ ] Monitoreo de errores activo
- [ ] Rate limiting ajustado

### Plataformas Soportadas
- **Render**: ConfiguraciÃ³n incluida en `render.yaml`
- **Railway**: Archivo `railway.json` incluido
- **Heroku**: Compatible con `Procfile`
- **Docker**: Dockerfile disponible
- **VPS**: Scripts de deployment incluidos

## ğŸ§ª Testing

```bash
# Ejecutar tests unitarios
pytest tests/unit/

# Tests de integraciÃ³n
pytest tests/integration/

# Coverage report
pytest --cov=app tests/

# Linting y formato
ruff check app/
black app/
```

## ğŸ“Š MÃ©tricas de Performance

- **Response Time**: < 200ms promedio
- **Uptime Target**: 99.9%
- **Rate Limit**: 30 req/min por usuario
- **PDF Generation**: < 3 segundos
- **Memory Usage**: < 512MB tÃ­pico

## ğŸ¤ ContribuciÃ³n

1. Fork el proyecto
2. Crea una rama feature (`git checkout -b feature/AmazingFeature`)
3. Commit cambios (`git commit -m 'ğŸš€ Add AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

### EstÃ¡ndares de CÃ³digo
- **Type Hints**: Usar tipos en todas las funciones
- **Docstrings**: Documentar clases y mÃ©todos pÃºblicos
- **Testing**: Cobertura mÃ­nima del 80%
- **Security**: Pasar anÃ¡lisis de seguridad

## ğŸ“„ Licencia

Proyecto privado de BGR Export. Todos los derechos reservados.

## ğŸ“ Soporte

**Soporte TÃ©cnico:**
- Email: soporte@bgr-export.com
- WhatsApp Empresarial: +593 968058769

**Desarrollador:**
- Email: rojassebas765@gmail.com
- GitHub: @tu-usuario

---

**VersiÃ³n:** 2.0.0 | **Ãšltima actualizaciÃ³n:** Enero 2025